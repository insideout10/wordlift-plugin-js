(function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F=[].indexOf||function(a){for(var b=0,c=this.length;c>b;b++)if(b in this&&this[b]===a)return b;return-1};A=function(){function a(a){this._html=a}return a.prototype._htmlPositions=[],a.prototype._textPositions=[],a.prototype._html="",a.prototype._text="",a.create=function(b){var c;return c=new a(b),c.parse(),c},a.prototype.parse=function(){var a,b,c,d,e,f,g,h,i;for(this._htmlPositions=[],this._textPositions=[],this._text="",f=/([^<]*)(<[^>]*>)([^<]*)/gim,g=0,b=0;e=f.exec(this._html);)d=e[1],a=e[2],c=e[3],i=d+("</p>"===a.toLowerCase()?"\n\n":""),h=c,g+=i.length,b+=d.length+a.length,0<c.length&&(this._htmlPositions.push(b),this._textPositions.push(g)),g+=h.length,b+=c.length,this._text+=i+h;return 0===this._textPositions.length||0!==this._textPositions[0]?(this._htmlPositions.unshift(0),this._textPositions.unshift(0)):void 0},a.prototype.text2html=function(a){var b,c,d,e,f;for(b=this._textPositions[0],d=this._textPositions[0],c=e=0,f=this._textPositions.length;(f>=0?f>e:e>f)&&!(a<this._textPositions[c]);c=f>=0?++e:--e)b=this._htmlPositions[c],d=this._textPositions[c];return b+a-d},a.prototype.html2text=function(a){var b,c,d,e,f;for(b=this._textPositions[0],d=this._textPositions[0],c=e=0,f=this._htmlPositions.length;(f>=0?f>e:e>f)&&!(a<this._htmlPositions[c]);c=f>=0?++e:--e)b=this._htmlPositions[c],d=this._textPositions[c];return d+a-b},a.prototype.insertHtml=function(a,b){var c;return c=this.text2html(b.text),this._html=this._html.substring(0,c)+a+this._html.substring(c),this.parse()},a.prototype.getHtml=function(){return this._html},a.prototype.getText=function(){return this._text},a}(),window.Traslator=A,e="@context",r="@graph",B="@value",b="analysisReceived",t="http://www.w3.org/2000/01/rdf-schema#",v=""+t+"label",u=""+t+"comment",n="freebase",o="http://rdf."+n+".com/",p=""+o+"ns/",q=""+p+"common.topic.description",x="http://schema.org/",y=""+x+"description",j="http://fise.iks-project.eu/ontology/",l=""+j+"EntityAnnotation",m=""+j+"TextAnnotation",k=""+j+"confidence",h="http://purl.org/dc/terms/",f="dbpedia",g="http://"+f+".org/",C="http://www.w3.org/2003/01/geo/wgs84_pos#",i="content",z="textannotation",d="#content_ifr",w="running",s=".mce_wordlift",c="contenteditable",angular.module("wordlift.tinymce.plugin.config",[]),angular.module("wordlift.tinymce.plugin.directives",["wordlift.tinymce.plugin.controllers"]).directive("wlEntities",function(){return{restrict:"E",scope:{textAnnotation:"=",onSelect:"&"},link:function(a){return a.select=function(b){var c,d,e;e=a.textAnnotation.entityAnnotations;for(d in e)c=e[d],c.selected=b.id===c.id&&!c.selected;return a.onSelect({textAnnotation:a.textAnnotation,entityAnnotation:b.selected?b:null})}},template:'<div>\n  <ul>\n    <li ng-repeat="entityAnnotation in textAnnotation.entityAnnotations | orderObjectBy:\'confidence\':true">\n      <wl-entity on-select="select(entityAnnotation)" entity-annotation="entityAnnotation"></wl-entity>\n    </li>\n  </ul>\n</div>'}}).directive("wlEntity",function(){return{restrict:"E",scope:{entityAnnotation:"=",onSelect:"&"},template:'<div class="entity {{entityAnnotation.entity.css}}" ng-class="{selected: true==entityAnnotation.selected}" ng-click="onSelect()" ng-show="entityAnnotation.entity.label">\n  <div class="thumbnail" ng-show="entityAnnotation.entity.thumbnail" title="{{entityAnnotation.entity.id}}" ng-attr-style="background-image: url({{entityAnnotation.entity.thumbnail}})"></div>\n  <div class="thumbnail empty" ng-hide="entityAnnotation.entity.thumbnail" title="{{entityAnnotation.entity.id}}"></div>\n  <div class="confidence" ng-bind="entityAnnotation.confidence"></div>\n  <div class="label" ng-bind="entityAnnotation.entity.label"></div>\n  <div class="type"></div>\n  <div class="source" ng-class="entityAnnotation.entity.source" ng-bind="entityAnnotation.entity.source"></div>\n</div>'}}).directive("wlEntityInputBoxes",function(){return{restrict:"E",scope:{textAnnotations:"="},template:"<div class=\"wl-entity-input-boxes\" ng-repeat=\"textAnnotation in textAnnotations\">\n  <div ng-repeat=\"entityAnnotation in textAnnotation.entityAnnotations | filterObjectBy:'selected':true\">\n\n    <input type='text' name='wl_entities[{{entityAnnotation.entity.id}}][uri]' value='{{entityAnnotation.entity.id}}'>\n    <input type='text' name='wl_entities[{{entityAnnotation.entity.id}}][label]' value='{{entityAnnotation.entity.label}}'>\n    <textarea name='wl_entities[{{entityAnnotation.entity.id}}][description]'>{{entityAnnotation.entity.description}}</textarea>\n\n    <input type='text' name='wl_entities[{{entityAnnotation.entity.id}}][main_type]' value='{{entityAnnotation.entity.type}}'>\n\n    <input ng-repeat=\"type in entityAnnotation.entity.types\" type='text'\n    	name='wl_entities[{{entityAnnotation.entity.id}}][type][]' value='{{type}}'>\n\n    <input ng-repeat=\"image in entityAnnotation.entity.thumbnails\" type='text'\n      name='wl_entities[{{entityAnnotation.entity.id}}][image][]' value='{{image}}'>\n    <input ng-repeat=\"sameAs in entityAnnotation.entity.sameAs\" type='text'\n      name='wl_entities[{{entityAnnotation.entity.id}}][sameas][]' value='{{sameAs}}'>\n\n    <input type='text' name='wl_entities[{{entityAnnotation.entity.id}}][latitude]' value='{{entityAnnotation.entity.latitude}}'>\n    <input type='text' name='wl_entities[{{entityAnnotation.entity.id}}][longitude]' value='{{entityAnnotation.entity.longitude}}'>\n\n  </div>\n</div>"}}),angular.module("AnalysisService",[]).service("AnalysisService",["EntityAnnotationService","TextAnnotationService","$filter","$http","$q","$rootScope",function(a,c,d,i,s,t){var w,z,A;return w=function(a,b){var c,d;for(d in a)if(c=a[d],b===(null!=c?c.id:void 0)||F.call(null!=c?c.sameAs:void 0,b)>=0)return c},z=function(a,b){var d;return d=c.find(a,b.start,b.end),null!=d?d:(d=c.create({text:b.label,start:b.start,end:b.end,confidence:1}),a[d.id]=d,d)},A={setKnownTypes:function(a){return function(b){return a._knownTypes=b}}(this),_knownTypes:[],promise:void 0,isRunning:!1,abort:function(){return this.isRunning&&null!=this.promise?this.promise.resolve():void 0},preselect:function(b,c){var d,e,f,g,h,i,j,k;for(k=[],i=0,j=c.length;j>i;i++)if(d=c[i],h=z(b.textAnnotations,d),g=a.find(h.entityAnnotations,{uri:d.uri}),0<g.length)k.push(g[0].selected=!0);else{if(f=w(b.entities,d.uri),f||(f=w(window.wordlift.entities,d.uri)),!f)throw"Missing entity in window.wordlift.entities collection!";b.entities[d.uri]=f,e=a.create({label:d.label,confidence:1,entity:b.entities[d.uri],relation:b.textAnnotations[h.id],selected:!0}),b.entityAnnotations[e.id]=e,k.push(h.entityAnnotations[e.id]=b.entityAnnotations[e.id])}return k},analyze:function(a,c){var d;return null==c&&(c=!1),this.isRunning?void 0:(this.isRunning=!0,this.promise=s.defer(),d=this,i({method:"post",url:ajaxurl+"?action=wordlift_analyze",data:a,timeout:this.promise.promise}).success(function(a){return t.$broadcast(b,d.parse(a,c)),d.isRunning=!1}).error(function(a,c){return d.isRunning=!1,t.$broadcast(b,void 0),0!==c?t.$broadcast("error","An error occurred while requesting an analysis."):void 0}))},parse:function(b){return function(i,s){var w,z,A,D,E,G,H,I,J,K,L,M,N,O,P,Q,R,S,T,U,V,W,X,Y,Z,$,_,ab,bb,cb,db,eb,fb,gb,hb,ib;if(null==s&&(s=!1),X=[],ab={},N={},K={},R=function(a){var c,e,f,g,h,i,j,k,l;for(g=[],c=void 0,l=b._knownTypes,j=0,k=l.length;k>j;j++)e=l[j],F.call(e.sameAs,"*")>=0&&(c=[{type:e}]),i=e.sameAs.concat(e.uri),f=function(){var b,c,d;for(d=[],b=0,c=i.length;c>b;b++)h=i[b],A(h,a)&&d.push(h);return d}(),0<f.length&&g.push({matches:f,type:e});return 0===g.length?c:(d("orderBy")(g,"matches",!0),g)},E=function(a,b){var c,d,e,h,i,j,k;return e=P("@id",a),k=P("@type",a),k=angular.isArray(k)?k:[k],i=P("http://www.w3.org/2002/07/owl#sameAs",a),i=angular.isArray(i)?i:[i],j=P(["http://xmlns.com/foaf/0.1/depiction",""+p+"common.topic.image",""+x+"image"],a,function(a){var b,c,d,e,f;for(a=angular.isArray(a)?a:[a],f=[],d=0,e=a.length;e>d;d++)c=a[d],b=/m\.(.*)$/i.exec(c),f.push(null===b?c:"https://usercontent.googleapis.com/"+n+"/v1/image/m/"+b[1]+"?maxwidth=4096&maxheight=4096");return f}),h=R(k),c=h[0].type.css,d={id:e,thumbnail:0<j.length?j[0]:null,thumbnails:j,css:c,type:h[0].type.uri,types:k,label:S(v,a,b),labels:P(v,a),sameAs:i,source:e.match("^"+o+".*$")?n:e.match("^"+g+".*$")?f:"wordlift",_item:a},d.description=S([u,q,y],a,b),d.descriptions=P([u,q,y],a),null==d.description&&(d.description=""),d.latitude=P(""+C+"lat",a),d.longitude=P(""+C+"long",a),(0===d.latitude.length||0===d.longitude.length)&&(d.latitude="",d.longitude=""),d},G=function(b){var c,d,e,f,g,i,l,m;if(e=P(""+j+"entity-reference",b),null==K[e])return[];for(c=[],g=P(""+h+"relation",b),g=angular.isArray(g)?g:[g],l=0,m=g.length;m>l;l++)f=g[l],i=ab[f],d=a.create({id:P("@id",b),label:P(""+j+"entity-label",b),confidence:P(k,b),entity:K[e],relation:i,_item:b}),null!=i&&(i.entityAnnotations[d.id]=d),c.push(d);return c},I=function(a){return c.create({id:P("@id",a),text:P(""+j+"selected-text",a)[B],start:P(""+j+"start",a),end:P(""+j+"end",a),confidence:P(k,a),entityAnnotations:{},_item:a})},H=function(a){return{code:P(""+h+"language",a),confidence:P(k,a),_item:a}},P=function(a,b,c){var d,e,f,g,h;if(!angular.isArray(a))return Q(a,b,c);for(f=[],g=0,h=a.length;h>g;g++)e=a[g],d=Q(e,b,c),d=angular.isArray(d)?d:[d],Z(f,d);return f},Q=function(a,b,c){var d,e,f;null==c&&(c=function(a){return a}),f=O(a);for(d in b)if(e=b[d],f===O(d))return c(e);return[]},S=function(a,b,c){var d,e,f,g;if(null!==(e=P(a,b))){for(e=angular.isArray(e)?e:[e],f=0,g=e.length;g>f;f++)if(d=e[f],c===d["@language"])return d[B];return null}},A=function(a,b){var c,d,e,f,g,h,i;if(null==b)return!1;if(e=angular.isArray(b)?b:[b],d=O(a),"@"===a.charAt(0)){for(f=0,h=e.length;h>f;f++)if(c=e[f],d===O(c))return!0}else for(g=0,i=e.length;i>g;g++)if(c=e[g],d===O(c))return!0;return!1},Z=function(a,b){var c,d,e,f;for(f=[],d=0,e=b.length;e>d;d++)c=b[d],F.call(a,c)<0&&f.push(a.push(c));return f},Y=function(a,b){var c,d,e,g,h;for(h=a.sameAs,e=0,g=h.length;g>e;e++)d=h[e],null!=b[d]&&b[d]!==a&&(c=b[d],Z(a.sameAs,c.sameAs),Z(a.thumbnails,c.thumbnails),a.source+=", "+c.source,f===c.source&&(a.description=c.description),f===c.source&&null!=c.longitude&&(a.longitude=c.longitude),f===c.source&&null!=c.latitude&&(a.latitude=c.latitude),b[d]=a,Y(a,b));return a},O=function(a){var b,c,d,e;return null===(b=a.match(/([\w|\d]+):(.*)/))?(d=a,c=""):(d=b[1],c=b[2]),e=null!=D[d]?angular.isString(D[d])?D[d]:D[d]["@id"]:d+":",e+c},null==i[e]||null==i[r])return t.$broadcast("error","The analysis response is invalid. Please try again later."),!1;for(D=i[e],T=i[r],cb=0,eb=T.length;eb>cb;cb++)V=T[cb],U=V["@id"],bb=V["@type"],J=P(""+h+"type",V),A(m,bb)&&A(""+h+"LinguisticSystem",J)?X.push(H(V)):A(m,bb)?ab[U]=V:A(l,bb)?N[U]=V:K[U]=V;X.sort(function(a,b){return a.confidence<b.confidence?-1:a.confidence>b.confidence?1:0}),W=X[0].code;for(U in K)V=K[U],K[U]=E(V,W);if(s)for(U in K)L=K[U],Y(L,K);for(U in ab)V=ab[U],ab[U]=I(V);for(U in N)for(V=N[U],gb=G(V),db=0,fb=gb.length;fb>db;db++)M=gb[db],N[M.id]=M;if(s)for(_ in ab){$=ab[_],hb=$.entityAnnotations;for(U in hb){M=hb[U],ib=$.entityAnnotations;for(z in ib)w=ib[z],U!==z&&M.entity===w.entity&&delete $.entityAnnotations[z]}}return{language:W,entities:K,entityAnnotations:N,textAnnotations:ab,languages:X}}}(this)}}]),angular.module("wordlift.tinymce.plugin.services.EditorService",["wordlift.tinymce.plugin.config","AnalysisService"]).service("EditorService",["AnalysisService","EntityAnnotationService","$rootScope",function(b,e,f){var g,h,j;return g=function(){return tinyMCE.get(i)},h=function(a){var b,c,d,e;for(d=A.create(a),c=/<(\w+)[^>]*\sitemid="([^"]+)"[^>]*>([^<]+)<\/\1>/gim,e=[];b=c.exec(a);)e.push({start:d.html2text(b.index),end:d.html2text(b.index+b[0].length),uri:b[2],label:b[3]});return e},j={embedAnalysis:function(a){var c,d,f,i,j,k,l,m,n,o,p;c=g(),k=c.getContent({format:"raw"}),f=h(k),b.preselect(a,f),k=k.replace(/<(\w+)[^>]*\sclass="textannotation[^"]*"[^>]*>([^<]+)<\/\1>/gim,"$2"),o=A.create(k),p=a.textAnnotations;for(n in p)m=p[n],0<Object.keys(m.entityAnnotations).length&&(d='<span id="'+n+'" class="'+z,j=e.find(m.entityAnnotations,{selected:!0}),0<j.length&&null!=j[0].entity&&(j[0].entity||console.log(j[0]),i=j[0].entity,d+=" highlight "+i.css+'" itemid="'+i.id),d+='">',o.insertHtml(d,{text:m.start}),o.insertHtml("</span>",{text:m.end}));return l=c.isDirty(),c.setContent(o.getHtml()),c.isNotDirty=!l},analyze:function(d){return b.isRunning?b.abort():(a(s).addClass(w),g().getBody().setAttribute(c,!1),b.analyze(d,!0))},getWinPos:function(b){var c,e;return c=g(),e=b.target,{top:a(d).offset().top-a("body").scrollTop()+e.offsetTop-a(c.getBody()).scrollTop(),left:a(d).offset().left-a("body").scrollLeft()+e.offsetLeft-a(c.getBody()).scrollLeft()}}},f.$on("selectEntity",function(a,b){var c,d,e,f,h,i;return d=g().dom,f=b.ta.id,c=z,null!=b.ea?(e=b.ea.entity,c+=" highlight "+e.css,i="itemscope",h=e.id):(i=null,h=null),d.setAttrib(f,"class",c),d.setAttrib(f,"itemscope",i),d.setAttrib(f,"itemid",h)}),f.$on("analysisReceived",function(b,d){return null!=d&&null!=d.textAnnotations&&j.embedAnalysis(d),a(s).removeClass(w),g().getBody().setAttribute(c,!0)}),j}]),angular.module("wordlift.tinymce.plugin.services.EntityAnnotationService",[]).service("EntityAnnotationService",["Helpers",function(a){return{create:function(b){var c;return c={id:"uri:local-entity-annotation-"+a.uniqueId(32),label:"",confidence:0,entity:null,relation:null,selected:!1,_item:null},a.merge(c,b)},find:function(a,b){var c,d;return null!=b.uri?function(){var e,f;f=[];for(d in a)c=a[d],(b.uri===c.entity.id||(e=b.uri,F.call(c.entity.sameAs,e)>=0))&&f.push(c);return f}():null!=b.selected?function(){var e;e=[];for(d in a)c=a[d],c.selected===b.selected&&e.push(c);return e}():void 0}}}]),angular.module("wordlift.tinymce.plugin.services.Helpers",[]).service("Helpers",[function(){return{merge:function(a,b){return this.extend(this.extend({},a),b)},extend:function(a,b){var c,d;for(c in b)d=b[c],a[c]=d;return a},uniqueId:function(a){var b;for(null==a&&(a=8),b="";b.length<a;)b+=Math.random().toString(36).substr(2);return b.substr(0,a)}}}]),angular.module("wordlift.tinymce.plugin.services.TextAnnotationService",[]).service("TextAnnotationService",["Helpers",function(a){return{create:function(b){var c;return null==b&&(b={}),c={id:"urn:local-text-annotation-"+a.uniqueId(32),text:"",start:0,end:0,confidence:0,entityAnnotations:{},_item:null},a.merge(c,b)},find:function(a,b,c){var d,e;for(e in a)if(d=a[e],d.start===b&&d.end===c)return d}}}]),angular.module("wordlift.tinymce.plugin.services",["wordlift.tinymce.plugin.config","wordlift.tinymce.plugin.services.EditorService","wordlift.tinymce.plugin.services.EntityAnnotationService","wordlift.tinymce.plugin.services.TextAnnotationService","wordlift.tinymce.plugin.services.Helpers","AnalysisService"]),angular.module("wordlift.tinymce.plugin.controllers",["wordlift.tinymce.plugin.config","wordlift.tinymce.plugin.services"]).filter("orderObjectBy",function(){return function(a,b,c){var d;return d=[],angular.forEach(a,function(a){return d.push(a)}),d.sort(function(a,c){return a[b]>c[b]}),c&&d.reverse(),d}}).filter("filterObjectBy",function(){return function(a,b,c){var d;return d=[],angular.forEach(a,function(a){return a[b]===c?d.push(a):void 0}),d}}).controller("EntitiesController",["EditorService","$log","$scope",function(b,c,d){var e,f,g;return d.analysis=null,d.textAnnotation=null,d.textAnnotationSpan=null,g=function(b){return a("head").append("<style>#wordlift-disambiguation-popover .postbox:before,#wordlift-disambiguation-popover .postbox:after{top:"+b+"px;}</style>")},e=void 0,f=function(){var a;if(null!=e)return a=b.getWinPos(e),g(a.top-50)},a(window).scroll(f),a("#content_ifr").contents().scroll(f),d.onEntitySelected=function(a,b){return d.$emit("selectEntity",{ta:a,ea:b}),window.wordlift.entities[b.entity.id]=b.entity},d.$on("analysisReceived",function(a,b){return d.analysis=b}),d.$on("textAnnotationClicked",function(c,e,f){var h,i;return d.textAnnotation=d.analysis.textAnnotations[e],null==(null!=(i=d.textAnnotation)?i.entityAnnotations:void 0)||0===Object.keys(d.textAnnotation.entityAnnotations).length?a("#wordlift-disambiguation-popover").hide():(h=b.getWinPos(f),g(h.top-50),a("#wordlift-disambiguation-popover").show())})}]).controller("ErrorController",["$element","$scope","$log",function(b,c){var d;return d=a(b).dialog({title:"WordLift",dialogClass:"wp-dialog",modal:!0,autoOpen:!1,closeOnEscape:!0,buttons:{Ok:function(){return a(this).dialog("close")}}}),c.$on("error",function(a,b){return c.message=b,d.dialog("open")})}]),a=jQuery,angular.module("wordlift.tinymce.plugin",["wordlift.tinymce.plugin.controllers","wordlift.tinymce.plugin.directives"]),a(D=a('<div id="wl-app" class="wl-app">\n  <div id="wl-error-controller" class="wl-error-controller" ng-controller="ErrorController">\n    <p ng-bind="message"></p>\n  </div>\n  <div id="wordlift-disambiguation-popover" class="metabox-holder" ng-controller="EntitiesController">\n    <div class="postbox">\n      <div class="handlediv" title="Click to toggle"><br></div>\n      <h3 class="hndle"><span>Semantic Web</span></h3>\n      <div class="inside">\n        <form role="form">\n          <div class="form-group">\n            <div class="ui-widget">\n              <input type="text" class="form-control" id="search" placeholder="search or create">\n            </div>\n          </div>\n\n          <wl-entities on-select="onEntitySelected(textAnnotation, entityAnnotation)" text-annotation="textAnnotation"></wl-entities>\n\n        </form>\n\n        <wl-entity-input-boxes text-annotations="analysis.textAnnotations"></wl-entity-input-boxes>\n      </div>\n    </div>\n  </div>\n</div>').appendTo("form[name=post]"),a("#wordlift-disambiguation-popover").css({display:"none",height:a("body").height()-a("#wpadminbar").height()+12,top:a("#wpadminbar").height()-1,right:20}).draggable(),a("#search").autocomplete({source:ajaxurl+"?action=wordlift_search",minLength:2,select:function(a,b){return console.log(a),console.log(b)}}).data("ui-autocomplete")._renderItem=function(b,c){return console.log(b),a("<li>").append('<li>\n  <div class="entity '+c.types+'">\n    <!-- div class="thumbnail" style="background-image: url(\'\')"></div -->\n    <div class="thumbnail empty"></div>\n    <div class="confidence"></div>\n    <div class="label">'+c.label+'</div>\n    <div class="type"></div>\n    <div class="source"></div>\n  </div>\n</li>').appendTo(b)},a("#wordlift-disambiguation-popover .handlediv").click(function(){return a("#wordlift-disambiguation-popover").hide()}),E=angular.bootstrap(a("#wl-app"),["wordlift.tinymce.plugin"]),E.invoke(["AnalysisService",function(a){return a.setKnownTypes(window.wordlift.types)}]),tinymce.PluginManager.add("wordlift",function(a){return a.addButton("wordlift",{text:"WordLift",icon:!1,onclick:function(){return E.invoke(["EditorService","$rootScope",function(a,b){return b.$apply(function(){var b,c;return b=tinyMCE.activeEditor.getContent({format:"raw"}),c=A.create(b).getText(),a.analyze(c)})}])}}),a.onClick.add(function(a,b){return E.invoke(["$rootScope",function(a){return a.$apply(function(){return a.$broadcast("textAnnotationClicked",b.target.id,b)})}])})}))}).call(this);
//# sourceMappingURL=wordlift.3.0.0-beta.min.map
(function(){var a,b,c,d=[].indexOf||function(a){for(var b=0,c=this.length;c>b;b++)if(b in this&&this[b]===a)return b;return-1};angular.module("wordlift.tinymce.plugin.config",[]).constant("Configuration",{supportedTypes:["schema:Place","schema:Event","schema:CreativeWork","schema:Product","schema:Person","schema:Organization"],entityLabels:{entityLabel:"enhancer:entity-label",entityType:"enhancer:entity-type",entityReference:"enhancer:entity-reference",textAnnotation:"enhancer:TextAnnotation",entityAnnotation:"enhancer:EntityAnnotation",selectionPrefix:"enhancer:selection-prefix",selectionSuffix:"enhancer:selection-suffix",selectedText:"enhancer:selected-text",confidence:"enhancer:confidence",relation:"dc:relation"}}),angular.module("wordlift.tinymce.plugin.directives",["wordlift.tinymce.plugin.controllers"]).directive("wlMetaBoxSelectedEntity",function(){return{restrict:"AE",scope:{index:"=",entity:"="},template:'<span>{{entity.label}} (<small>{{entity.type}}</span>)\n\n<br /><small>{{entity.thumbnail}}</small>\n<input type="hidden" name="entities[{{index}}][\'id\']" value="{{entity.id}}" />\n\n<input type="hidden" name="entities[{{index}}][\'label\']" value="{{entity.label}}" />\n\n<input type="hidden" name="entities[{{index}}][\'description\']" value="{{entity.description}}" />\n\n<input type="hidden" name="entities[{{index}}][\'type\']" value="{{entity.type}}" />\n\n<input type="hidden" name="entities[{{index}}][\'thumbnail\']" value="{{entity.thumbnail}}" />\n'}}).directive("wlEntities",function(){return{restrict:"E",scope:{textAnnotation:"=",onSelect:"&"},link:function(a){return a.select=function(b){var c,d,e;e=a.textAnnotation.entityAnnotations;for(d in e)c=e[d],c.selected=b.id===c.id&&!c.selected;return a.onSelect({textAnnotation:a.textAnnotation,entityAnnotation:b.selected?b:null})}},template:'<div>\n  <ul>\n    <li ng-repeat="entityAnnotation in textAnnotation.entityAnnotations | orderObjectBy:\'confidence\':true">\n      <wl-entity on-select="select(entityAnnotation)" entity-annotation="entityAnnotation"></wl-entity>\n    </li>\n  </ul>\n</div>'}}).directive("wlEntity",function(){return{restrict:"E",scope:{entityAnnotation:"=",onSelect:"&"},template:'<div class="entity {{entityAnnotation.entity.type}}" ng-class="{selected: true==entityAnnotation.selected}" ng-click="onSelect()" ng-show="entityAnnotation.entity.label">\n  <div class="thumbnail" ng-show="entityAnnotation.entity.thumbnail" title="{{entityAnnotation.entity.id}}" ng-attr-style="background-image: url({{entityAnnotation.entity.thumbnail}})"></div>\n  <div class="thumbnail empty" ng-hide="entityAnnotation.entity.thumbnail" title="{{entityAnnotation.entity.id}}"></div>\n  <div class="confidence" ng-bind="entityAnnotation.confidence"></div>\n  <div class="label" ng-bind="entityAnnotation.entity.label"></div>\n  <div class="type"></div>\n  <div class="source" ng-class="entityAnnotation.entity.source" ng-bind="entityAnnotation.entity.source"></div>\n</div>'}}).directive("wlEntityInputBoxes",function(){return{restrict:"E",scope:{textAnnotations:"="},template:"<div class=\"wl-entity-input-boxes\" ng-repeat=\"textAnnotation in textAnnotations\">\n  <div ng-repeat=\"entityAnnotation in textAnnotation.entityAnnotations | filterObjectBy:'selected':true\">\n\n    <input type='text' name='wl_entities[{{entityAnnotation.entity.id}}][uri]' value='{{entityAnnotation.entity.id}}'>\n    <input type='text' name='wl_entities[{{entityAnnotation.entity.id}}][label]' value='{{entityAnnotation.entity.label}}'>\n    <textarea name='wl_entities[{{entityAnnotation.entity.id}}][description]'>{{entityAnnotation.entity.description}}</textarea>\n    <input type='text' name='wl_entities[{{entityAnnotation.entity.id}}][type]' value='{{entityAnnotation.entity.type}}'>\n\n    <input ng-repeat=\"image in entityAnnotation.entity.thumbnails\" type='text'\n      name='wl_entities[{{entityAnnotation.entity.id}}][image][]' value='{{image}}'>\n    <input ng-repeat=\"sameAs in entityAnnotation.entity.sameAs\" type='text'\n      name='wl_entities[{{entityAnnotation.entity.id}}][sameas][]' value='{{sameAs}}'>\n\n  </div>\n</div>"}}),angular.module("AnalysisService",[]).service("AnalysisService",["$http","$q","$rootScope","$log",function(a,b,c){return{isRunning:!1,analyze:function(b,d){var e;return null==d&&(d=!1),this.isRunning?void 0:(this.isRunning=!0,e=this,a.post(ajaxurl+"?action=wordlift_analyze",{data:b}).success(function(a){return c.$broadcast("analysisReceived",e.parse(a,d)),e.isRunning=!1}).error(function(){return console.log("error received"),e.isRunning=!1}))},parse:function(a,b){var c,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G;null==b&&(b=!1),y=[],C={},n={},k={},r=function(a){var b,c,d,e,f,g,h,i,j,k,l,m,n,p,q,r,s,t,u,v,w,x,y,z,A,B;if(null==a)return null;for(c=angular.isArray(a)?a:[a],d=0,h=c.length;h>d;d++)if(b=c[d],"http://schema.org/Person"===o(b))return"person";for(e=0,i=c.length;i>e;e++)if(b=c[e],"http://rdf.freebase.com/ns/people.person"===o(b))return"person";for(f=0,l=c.length;l>f;f++)if(b=c[f],"http://schema.org/Organization"===o(b))return"organization";for(g=0,m=c.length;m>g;g++)if(b=c[g],"http://rdf.freebase.com/ns/government.government"===o(b))return"organization";for(u=0,n=c.length;n>u;u++)if(b=c[u],"http://schema.org/Newspaper"===o(b))return"organization";for(v=0,p=c.length;p>v;v++)if(b=c[v],"http://schema.org/Place"===o(b))return"place";for(w=0,q=c.length;q>w;w++)if(b=c[w],"http://rdf.freebase.com/ns/location.location"===o(b))return"place";for(x=0,r=c.length;r>x;x++)if(b=c[x],"http://schema.org/Event"===o(b))return"event";for(y=0,s=c.length;s>y;y++)if(b=c[y],"http://dbpedia.org/ontology/Event"===o(b))return"event";for(z=0,t=c.length;t>z;z++)if(b=c[z],"http://rdf.freebase.com/ns/music.artist"===o(b))return"music";for(A=0,j=c.length;j>A;A++)if(b=c[A],"http://schema.org/MusicAlbum"===o(b))return"music";for(B=0,k=c.length;k>B;B++)if(b=c[B],"http://www.opengis.net/gml/_Feature"===o(b))return"place";return"thing"},f=function(a,b){var c,d,e,f,g;return d=p("@id",a),g=p("@type",a),e=p("owl:sameAs",a),e=angular.isArray(e)?e:[e],f=p(["foaf:depiction","http://rdf.freebase.com/ns/common.topic.image","schema:image"],a,function(a){var b,c,d,e,f;for(a=angular.isArray(a)?a:[a],f=[],d=0,e=a.length;e>d;d++)c=a[d],b=/m\.(.*)$/i.exec(c),f.push(null===b?c:"https://usercontent.googleapis.com/freebase/v1/image/m/"+b[1]+"?maxwidth=4096&maxheight=4096");return f}),c={id:d,thumbnail:0<f.length?f[0]:null,thumbnails:f,type:r(g),types:g,label:s("rdfs:label",a,b),labels:p("rdfs:label",a),sameAs:e,source:d.match("^http://rdf.freebase.com/.*$")?"freebase":d.match("^http://dbpedia.org/.*$")?"dbpedia":"wordlift",_item:a},c.description=s(["rdfs:comment","http://rdf.freebase.com/ns/common.topic.description","schema:description"],a,b),c.descriptions=p(["rdfs:comment","http://rdf.freebase.com/ns/common.topic.description","schema:description"],a),null==c.description&&(c.description=""),c},g=function(a){var b,c,d;return b=k[p("enhancer:entity-reference",a)],null==b?null:(d=C[p("dc:relation",a)],c={id:p("@id",a),label:p("enhancer:entity-label",a),confidence:p("enhancer:confidence",a),entity:b,relation:C[p("dc:relation",a)],_item:a},null!=d&&(d.entityAnnotations[c.id]=c),c)},i=function(a){return{id:p("@id",a),selectedText:p("enhancer:selected-text",a)["@value"],selectionPrefix:p("enhancer:selection-prefix",a)["@value"],selectionSuffix:p("enhancer:selection-suffix",a)["@value"],confidence:p("enhancer:confidence",a),entityAnnotations:{},_item:a}},h=function(a){return{code:p("dc:language",a),confidence:p("enhancer:confidence",a),_item:a}},p=function(a,b,c){var d,e,f,g,h;if(!angular.isArray(a))return q(a,b,c);for(f=[],g=0,h=a.length;h>g;g++)e=a[g],d=q(e,b,c),d=angular.isArray(d)?d:[d],A(f,d);return f},q=function(a,b,c){var d,e,f;null==c&&(c=function(a){return a}),f=o(a);for(d in b)if(e=b[d],f===o(d))return c(e);return[]},s=function(a,b,c){var d,e,f,g;if(null!==(e=p(a,b))){for(e=angular.isArray(e)?e:[e],f=0,g=e.length;g>f;f++)if(d=e[f],c===d["@language"])return d["@value"];return null}},c=function(a,b){var c,d,e,f,g;if(null==b)return!1;for(e=angular.isArray(b)?b:[b],d=o(a),f=0,g=e.length;g>f;f++)if(c=e[f],d===o(c))return!0;return!1},A=function(a,b){var c,e,f,g;for(g=[],e=0,f=b.length;f>e;e++)c=b[e],d.call(a,c)<0&&g.push(a.push(c));return g},z=function(a,b){var c,d,e,f,g;for(g=a.sameAs,e=0,f=g.length;f>e;e++)d=g[e],null!=b[d]&&(c=b[d],A(a.sameAs,c.sameAs),A(a.thumbnails,c.thumbnails),a.source+=", "+c.source,"dbpedia"===c.source&&(a.description=c.description),delete b[d],z(a,b));return a},o=function(a){var b,c,d,e;return null===(b=a.match(/([\w|\d]+):(.*)/))?a:(d=b[1],c=b[2],e=null!=B[d]?B[d]:""+d+":",e+c)},e=null!=a["@context"]?a["@context"]:{},t=null!=a["@graph"]?a["@graph"]:{},B=[];for(w in e)E=e[w],-1===w.indexOf(":")&&angular.isString(E)&&(B[w]=E);for(F=0,G=t.length;G>F;F++)v=t[F],u=v["@id"],D=v["@type"],j=p("dc:type",v),c("enhancer:TextAnnotation",D)&&c("dc:LinguisticSystem",j)?y.push(h(v)):c("enhancer:TextAnnotation",D)?C[u]=v:c("enhancer:EntityAnnotation",D)?n[u]=v:k[u]=v;y.sort(function(a,b){return a.confidence<b.confidence?-1:a.confidence>b.confidence?1:0}),x=y[0].code;for(u in k)v=k[u],k[u]=f(v,x);if(b)for(u in k)l=k[u],z(l,k);for(u in C)v=C[u],C[u]=i(v);for(u in n)v=n[u],m=g(v),null!=m?n[u]=m:delete n[u];return{language:x,entities:k,entityAnnotations:n,textAnnotations:C,languages:y}}}}]),angular.module("wordlift.tinymce.plugin.services.EditorService",["wordlift.tinymce.plugin.config","AnalysisService"]).service("EditorService",["AnalysisService","$rootScope","$log","Configuration",function(b,c,d){var e;return e={embedAnalysis:function(a){var b,e,f,g,h,i,j,k,l,m,n,o,p,q,r;for(b=function(a){return a.replace("\\","\\\\").replace("(","\\(").replace(")","\\)").replace("\n","\\n?").replace("-","\\-").replace(" ","\\s").replace("Â ","&nbsp;")},e=tinyMCE.get("content").getContent({format:"raw"}),p=new RegExp('<span[^>]+class="textannotation"[^>]*>([^<]*)</span>',"gi");p.test(e);)e=e.replace(p,"$1");r=a.textAnnotations;for(f in r)q=r[f],m=b(q.selectionPrefix.substr(-1)),""===m&&(m="^|\\W"),n=b(q.selectionSuffix.substr(0,1)),""===n&&(n="$|\\W"),o=q.selectedText,j=new RegExp("("+m+"(?:<[^>]+>){0,})("+o+")((?:<[^>]+>){0,}"+n+')(?![^<]*"[^<]*>)'),k=new RegExp('id="(urn:enhancement.[a-z,0-9,-]+)"'),(i=e.match(j))&&(l=""+i[1]+'<span class="textannotation" id="'+f+'" typeof="http://fise.iks-project.eu/ontology/TextAnnotation">'+i[2]+"</span>"+i[3],k.test(i[1])&&(h=i[1].replace(k,'id="'+f+'"'),l=""+h+i[2]+i[3]),e=e.replace(j,l));return g=tinyMCE.get("content").isDirty(),tinyMCE.get("content").setContent(e),g||(tinyMCE.get("content").isNotDirty=1),tinyMCE.get("content").onClick.add(function(a,b){return c.$apply(d.debug("Going to notify click on annotation with id "+b.target.id),c.$broadcast("textAnnotationClicked",b.target.id,b))})},ping:function(a){return d.debug(a)},analyze:function(c){return b.isRunning?void 0:(a(".mce_wordlift").addClass("running"),tinyMCE.get("content").getBody().setAttribute("contenteditable",!1),b.analyze(c,!0))},getEditor:function(){return tinyMCE.get("content")},getBody:function(){return this.getEditor().getBody()},getDOM:function(){return this.getEditor().dom},getWinPos:function(b){var c,d,e,f;return c=this.getEditor(),d=b.target,f=a("#content_ifr").offset().top-a("body").scrollTop()+d.offsetTop-a(c.getBody()).scrollTop(),e=a("#content_ifr").offset().left-a("body").scrollLeft()+d.offsetLeft-a(c.getBody()).scrollLeft(),{top:f,left:e}}},c.$on("DisambiguationWidget.entitySelected",function(a,b){var c,d,e,f;return c="textannotation highlight "+b.entity.type+" disambiguated",d=tinyMCE.get("content").dom,f=b.relation.id,e=d.get(f),d.setAttrib(f,"class",c),d.setAttrib(f,"itemscope","itemscope"),d.setAttrib(f,"itemtype",b.entity.type),d.setAttrib(f,"itemid",b.entity.id)}),c.$on("analysisReceived",function(b,c){return e.embedAnalysis(c),a(".mce_wordlift").removeClass("running"),tinyMCE.get("content").getBody().setAttribute("contenteditable",!0)}),e}]),angular.module("wordlift.tinymce.plugin.services.EntityService",["wordlift.tinymce.plugin.config"]).service("EntityService",["$log",function(b){var c;return c=a("#wordlift_selected_entitities_box"),{select:function(d){var e,f,g,h,i,j,k,l,m,n;if(b.info("select"),b.info(d),f=d.entity,h=f.id,k=f.label,e=null!=f.description?f.description:"",j=f.thumbnails,l=f.type,g=a("<div itemid='"+h+"'></div>").append("<input type='text' name='wl_entities["+h+"][uri]' value='"+h+"'>").append("<input type='text' name='wl_entities["+h+"][label]' value='"+k+"'>").append("<input type='text' name='wl_entities["+h+"][description]' value='"+e+"'>").append("<input type='text' name='wl_entities["+h+"][type]' value='"+l+"'>"),angular.isArray(j))for(m=0,n=j.length;n>m;m++)i=j[m],g.append("<input type='text' name='wl_entities["+h+"][image]' value='"+i+"'>");else g.append("<input type='text' name='wl_entities["+h+"][image]' value='"+j+"'>");return c.append(g)},deselect:function(c){var d,e;return b.info("deselect"),b.info(c),d=c.entity,e=d.id,a("div[itemid='"+e+"']").remove()}}}]),angular.module("wordlift.tinymce.plugin.services",["wordlift.tinymce.plugin.config","wordlift.tinymce.plugin.services.EditorService","AnalysisService","wordlift.tinymce.plugin.services.EntityService"]),angular.module("wordlift.tinymce.plugin.controllers",["wordlift.tinymce.plugin.config","wordlift.tinymce.plugin.services"]).filter("orderObjectBy",function(){return function(a,b,c){var d;return d=[],angular.forEach(a,function(a){return d.push(a)}),d.sort(function(a,c){return a[b]>c[b]}),c&&d.reverse(),d}}).filter("filterObjectBy",function(){return function(a,b,c){var d;return d=[],angular.forEach(a,function(a){return a[b]===c?d.push(a):void 0}),d}}).controller("EntitiesController",["EditorService","EntityService","$log","$scope","Configuration",function(b,c,d,e,f){var g,h,i;return e.analysis=null,e.textAnnotation=null,e.textAnnotationSpan=null,e.sortByConfidence=function(a){return a[f.entityLabels.confidence]},e.getLabelFor=function(a){return f.entityLabels[a]},i=function(b){return a("head").append("<style>#wordlift-disambiguation-popover .postbox:before,#wordlift-disambiguation-popover .postbox:after{top:"+b+"px;}</style>")},g=void 0,h=function(){var a;if(null!=g)return a=b.getWinPos(g),i(a.top-50)},a(window).scroll(h),a("#content_ifr").contents().scroll(h),e.onEntitySelected=function(a,b){return e.$emit("DisambiguationWidget.entitySelected",b)},e.$on("analysisReceived",function(a,b){return e.analysis=b}),e.$on("textAnnotationClicked",function(c,d,f){var g,h,j;return e.textAnnotationSpan=angular.element(f.target),e.textAnnotation=e.analysis.textAnnotations[d],0===(null!=(h=e.textAnnotation)?null!=(j=h.entityAnnotations)?j.length:void 0:void 0)?a("#wordlift-disambiguation-popover").hide():(g=b.getWinPos(f),i(g.top-50),a("#wordlift-disambiguation-popover").show())})}]),a=jQuery,angular.module("wordlift.tinymce.plugin",["wordlift.tinymce.plugin.controllers","wordlift.tinymce.plugin.directives"]),a(b=a('<div id="wordlift-disambiguation-popover" class="metabox-holder">\n  <div class="postbox">\n    <div class="handlediv" title="Click to toggle"><br></div>\n    <h3 class="hndle"><span>Semantic Web</span></h3>\n    <div class="inside">\n      <form role="form">\n        <div class="form-group">\n          <div class="ui-widget">\n            <input type="text" class="form-control" id="search" placeholder="search or create">\n          </div>\n        </div>\n\n        <wl-entities on-select="onEntitySelected(textAnnotation, entityAnnotation)" text-annotation="textAnnotation"></wl-entities>\n\n      </form>\n\n      <wl-entity-input-boxes text-annotations="analysis.textAnnotations"></wl-entity-input-boxes>\n    </div>\n  </div>\n</div>').appendTo("form[name=post]").css({display:"none",height:a("body").height()-a("#wpadminbar").height()+32,top:a("#wpadminbar").height()-1,right:0}).draggable(),a("#search").autocomplete({source:ajaxurl+"?action=wordlift_search",minLength:2,select:function(a,b){return console.log(a),console.log(b)}}).data("ui-autocomplete")._renderItem=function(b,c){return console.log(b),a("<li>").append('<li>\n  <div class="entity '+c.types+'">\n    <!-- div class="thumbnail" style="background-image: url(\'\')"></div -->\n    <div class="thumbnail empty"></div>\n    <div class="confidence"></div>\n    <div class="label">'+c.label+'</div>\n    <div class="type"></div>\n    <div class="source"></div>\n  </div>\n</li>').appendTo(b)},a("#wordlift-disambiguation-popover .handlediv").click(function(){return b.hide()}),a("body").attr("ng-controller","EntitiesController"),c=angular.bootstrap(document,["wordlift.tinymce.plugin"]),tinymce.PluginManager.add("wordlift",function(a){return a.addButton("wordlift",{text:"WordLift",icon:!1,onclick:function(){return c.invoke(["EditorService",function(a){return a.analyze(tinyMCE.activeEditor.getContent({format:"text"}))}])}})}))}).call(this);
//# sourceMappingURL=wordlift.3.0.0-SNAPSHOT.min.map
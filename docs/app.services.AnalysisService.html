<!DOCTYPE html>

<html>
<head>
  <title>app.services.AnalysisService.coffee</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="app.html">
                app.coffee
              </a>
            
              
              <a class="source" href="app.config.html">
                app.config.coffee
              </a>
            
              
              <a class="source" href="app.constants.html">
                app.constants.coffee
              </a>
            
              
              <a class="source" href="app.controllers.html">
                app.controllers.coffee
              </a>
            
              
              <a class="source" href="app.directives.html">
                app.directives.coffee
              </a>
            
              
              <a class="source" href="app.directives.wlEntityProps.html">
                app.directives.wlEntityProps.coffee
              </a>
            
              
              <a class="source" href="app.services.AnalysisService.html">
                app.services.AnalysisService.coffee
              </a>
            
              
              <a class="source" href="app.services.EditorService.html">
                app.services.EditorService.coffee
              </a>
            
              
              <a class="source" href="app.services.EntityAnnotationService.html">
                app.services.EntityAnnotationService.coffee
              </a>
            
              
              <a class="source" href="app.services.EntityService.html">
                app.services.EntityService.coffee
              </a>
            
              
              <a class="source" href="app.services.Helpers.html">
                app.services.Helpers.coffee
              </a>
            
              
              <a class="source" href="app.services.LoggerService.html">
                app.services.LoggerService.coffee
              </a>
            
              
              <a class="source" href="app.services.TextAnnotationService.html">
                app.services.TextAnnotationService.coffee
              </a>
            
              
              <a class="source" href="app.services.html">
                app.services.coffee
              </a>
            
              
              <a class="source" href="traslator.html">
                traslator.coffee
              </a>
            
              
              <a class="source" href="chord.html">
                chord.coffee
              </a>
            
              
              <a class="source" href="timeline.html">
                timeline.coffee
              </a>
            
              
              <a class="source" href="EntitiesController.spec.html">
                EntitiesController.spec.coffee
              </a>
            
              
              <a class="source" href="addtl_properties.spec.html">
                addtl_properties.spec.coffee
              </a>
            
              
              <a class="source" href="controllers.error.spec.html">
                controllers.error.spec.coffee
              </a>
            
              
              <a class="source" href="directives.spec.html">
                directives.spec.coffee
              </a>
            
              
              <a class="source" href="services.spec.html">
                services.spec.coffee
              </a>
            
              
              <a class="source" href="tinymce.questa_volta_parliamo_di_seo.spec.html">
                tinymce.questa_volta_parliamo_di_seo.spec.coffee
              </a>
            
              
              <a class="source" href="tinymce.spec.html">
                tinymce.spec.coffee
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>app.services.AnalysisService.coffee</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <p>The AnalysisService aim is to parse the Analysis response from an analysis process
and create a data structure that’s is suitable for displaying in the UI.
The main method of the AnalysisService is parse. The parse method includes some
helpful functions.
The return is a structure like this:</p>
<ul>
<li>language : the language code for the specified post.</li>
<li>languages: an array of languages (and related confidence) identified for the provided text.</li>
<li>entities : the list of entities for the post, each entity provides:<ul>
<li>label      : the label in the post language.</li>
<li>description: the description in the post language.</li>
<li>type       : the known type for the entity</li>
<li>types      : a list of types as provided by the entity</li>
<li>thumbnails : URL to thumbnail images</li>
</ul>
</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>
angular.<span class="hljs-built_in">module</span>(<span class="hljs-string">'AnalysisService'</span>, [<span class="hljs-string">'wordlift.tinymce.plugin.services.EntityService'</span>, <span class="hljs-string">'wordlift.tinymce.plugin.services.Helpers'</span>, <span class="hljs-string">'LoggerService'</span>])
.service(<span class="hljs-string">'AnalysisService'</span>,
    [ <span class="hljs-string">'EntityAnnotationService'</span>, <span class="hljs-string">'EntityService'</span>, <span class="hljs-string">'Helpers'</span>, <span class="hljs-string">'LoggerService'</span>, <span class="hljs-string">'TextAnnotationService'</span>, <span class="hljs-string">'$filter'</span>, <span class="hljs-string">'$http'</span>, <span class="hljs-string">'$q'</span>,
      <span class="hljs-string">'$rootScope'</span>, <span class="hljs-string">'$log'</span>,
      <span class="hljs-function"><span class="hljs-params">(EntityAnnotationService, EntityService, h, logger, TextAnnotationService, $filter, $http, $q, $rootScope, $log)</span> -&gt;</span>

        service =
          <span class="hljs-attribute">_knownTypes</span>: []
          <span class="hljs-attribute">_entities</span>: {}</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>Holds the analysis promise, used to abort the analysis.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="hljs-attribute">promise</span>: <span class="hljs-literal">undefined</span></pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>If true, an analysis is running.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="hljs-attribute">isRunning</span>: <span class="hljs-literal">false</span></pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>Add an entity to the local collection of entities.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        service.<span class="hljs-function"><span class="hljs-title">addEntity</span> = <span class="hljs-params">(entity)</span> -&gt;</span>
          <span class="hljs-property">@_entities</span>[entity.id] = entity</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>Set the local entity collection.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        service.<span class="hljs-function"><span class="hljs-title">setEntities</span> = <span class="hljs-params">(entities)</span> -&gt;</span>
          <span class="hljs-property">@_entities</span> = entities</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>Set the known types.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        service.<span class="hljs-function"><span class="hljs-title">setKnownTypes</span> = <span class="hljs-params">(types)</span> -&gt;</span>
          <span class="hljs-property">@_knownTypes</span> = types
          $rootScope.$broadcast CONFIGURATION_TYPES_EVENT, types
          <span class="hljs-property">@_knownTypes</span></pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>Get the known types.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        service.<span class="hljs-function"><span class="hljs-title">getKnownTypes</span> = <span class="hljs-params">()</span> -&gt;</span>
          <span class="hljs-property">@_knownTypes</span></pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>Abort a running analysis.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        service.<span class="hljs-function"><span class="hljs-title">abort</span> = -&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>Abort the analysis if an analysis is running and there’s a reference to its promise.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="hljs-property">@promise</span>.resolve() <span class="hljs-keyword">if</span> <span class="hljs-property">@isRunning</span> <span class="hljs-keyword">and</span> <span class="hljs-property">@promise</span>?</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>Enhance analysis with a new text annotation</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        service.<span class="hljs-function"><span class="hljs-title">addTextAnnotation</span> = <span class="hljs-params">(analysis, textAnnotation)</span>-&gt;</span>
          analysis.textAnnotations[textAnnotation.id] = textAnnotation
          textAnnotation</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>Enhance analysis with a new entity annotation</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        service.<span class="hljs-function"><span class="hljs-title">enhance</span> = <span class="hljs-params">(analysis, textAnnotation, entityAnnotation)</span>-&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>Look for an existing entityAnnotation for the current uri</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          entityAnnotations = EntityAnnotationService.find textAnnotation.entityAnnotations, <span class="hljs-attribute">uri</span>: entityAnnotation.entity.id
          <span class="hljs-keyword">if</span> <span class="hljs-number">0</span> <span class="hljs-keyword">is</span> entityAnnotations.length</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>Add the current entity to the current analysis</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            analysis.entities[entityAnnotation.entity.id] = entityAnnotation.entity</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>Unflag selected entityAnnotations for the current textAnnotation</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">for</span> id, ea <span class="hljs-keyword">of</span> textAnnotation.entityAnnotations
              ea.selected = <span class="hljs-literal">false</span></pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>Flag the current entityAnnotation as selected</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            entityAnnotation.selected = <span class="hljs-literal">true</span></pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>Add the current entityAnnotation to the current analysis</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            analysis.entityAnnotations[entityAnnotation.id] = entityAnnotation</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>Add a reference to the current textAnnotation</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            textAnnotation.entityAnnotations[entityAnnotation.id] = analysis.entityAnnotations[entityAnnotation.id]</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>Return true</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span></pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>Return false </p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="hljs-literal">false</span></pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>Preselect entity annotations in the provided analysis using the provided collection of annotations.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        service.<span class="hljs-function"><span class="hljs-title">preselect</span> = <span class="hljs-params">(analysis, annotations)</span> -&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>Find the existing entities in the html</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="hljs-keyword">for</span> annotation <span class="hljs-keyword">in</span> annotations
            textAnnotation = TextAnnotationService.findOrCreate analysis.textAnnotations, annotation
            entityAnnotations = EntityAnnotationService.find textAnnotation.entityAnnotations, <span class="hljs-attribute">uri</span>: annotation.uri
            <span class="hljs-keyword">if</span> <span class="hljs-number">0</span> &lt; entityAnnotations.length</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>We don’t expect more than one entity annotation for an URI inside a text annotation.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>              entityAnnotations[<span class="hljs-number">0</span>].selected = <span class="hljs-literal">true</span>
            <span class="hljs-keyword">else</span></pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>Retrieve entity from analysis or from the entity storage if needed</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>              entities = EntityService.find analysis.entities, <span class="hljs-attribute">uri</span>: annotation.uri
              entities = EntityService.find <span class="hljs-property">@_entities</span>, <span class="hljs-attribute">uri</span>: annotation.uri <span class="hljs-keyword">if</span> <span class="hljs-number">0</span> <span class="hljs-keyword">is</span> entities.length</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>If the entity is missing raise an excpetion!</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>              <span class="hljs-keyword">if</span> <span class="hljs-number">0</span> <span class="hljs-keyword">is</span> entities.length
                $log.error <span class="hljs-string">"Missing entity in window.wordlift.entities collection!"</span>
                $log.info annotation</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>TODO: wouldn’t it be better to continue here instead of throwing an exception?</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-keyword">continue</span></pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>Use the first found entity</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>              analysis.entities[annotation.uri] = entities[<span class="hljs-number">0</span>]</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>Create the new entityAssociation</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>              ea = EntityAnnotationService.create
                <span class="hljs-attribute">label</span>: annotation.label
                <span class="hljs-attribute">confidence</span>: <span class="hljs-number">1</span>
                <span class="hljs-attribute">entity</span>: analysis.entities[annotation.uri]
                <span class="hljs-attribute">relation</span>: analysis.textAnnotations[textAnnotation.id]
                <span class="hljs-attribute">selected</span>: <span class="hljs-literal">true</span>

              analysis.entityAnnotations[ea.id] = ea</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>Add a reference to the current textAssociation</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>              textAnnotation.entityAnnotations[ea.id] = analysis.entityAnnotations[ea.id]</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p><a name="analyze"></a>
Analyze the provided content. Only one analysis at a time is run.
The merge parameter is passed to the parse call and merges together entities related via sameAs.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        service.<span class="hljs-function"><span class="hljs-title">analyze</span> = <span class="hljs-params">(content, merge = <span class="hljs-literal">false</span>)</span> -&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>dump “AnalysisService.analyze [ content :: #{content} ][ is running :: #{@isRunning} ][ merge :: #{merge} ]”
Exit if an analysis is already running.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="hljs-keyword">return</span> <span class="hljs-keyword">if</span> service.isRunning</pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p>Set that an analysis is running.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          service.isRunning = <span class="hljs-literal">true</span></pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p>Store the promise in the class to allow interrupting the request.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          service.promise = $q.defer()

          $http(
            <span class="hljs-attribute">method</span>: <span class="hljs-string">'post'</span>
            <span class="hljs-attribute">url</span>: ajaxurl + <span class="hljs-string">'?action=wordlift_analyze'</span>
            <span class="hljs-attribute">data</span>: content
            <span class="hljs-attribute">timeout</span>: service.promise.promise
          )</pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <p>If successful, broadcast an <em>analysisReceived</em> event.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          .success <span class="hljs-function"><span class="hljs-params">(data)</span> -&gt;</span>
              $rootScope.$broadcast ANALYSIS_EVENT, service.parse(data, merge)</pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p>Set that the analysis is complete.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>              service.isRunning = <span class="hljs-literal">false</span>

          .error <span class="hljs-function"><span class="hljs-params">(data, status)</span> -&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <p>Set that the analysis is complete.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>              service.isRunning = <span class="hljs-literal">false</span>
              $rootScope.$broadcast ANALYSIS_EVENT, <span class="hljs-literal">undefined</span>

              <span class="hljs-keyword">return</span> <span class="hljs-keyword">if</span> <span class="hljs-number">0</span> <span class="hljs-keyword">is</span> status <span class="hljs-comment"># analysis aborted.</span>
              $rootScope.$broadcast <span class="hljs-string">'error'</span>, <span class="hljs-string">'An error occurred while requesting an analysis.'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <p>Parse the response data from the analysis request (Redlink).
If <em>merge</em> is set to true, entity annotations and entities with matching sameAs will be merged.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        service.<span class="hljs-function"><span class="hljs-title">parse</span> = <span class="hljs-params">(data, merge = <span class="hljs-literal">false</span>)</span> -&gt;</span>
          languages = []
          textAnnotations = {}
          entityAnnotations = {}
          entities = {}

          <span class="hljs-function"><span class="hljs-title">createLanguage</span> = <span class="hljs-params">(item)</span> -&gt;</span>
            {
            <span class="hljs-attribute">code</span>: h.get <span class="hljs-string">"<span class="hljs-subst">#{DCTERMS}</span>language"</span>, item, context
            <span class="hljs-attribute">confidence</span>: h.get FISE_ONT_CONFIDENCE, item, context
            <span class="hljs-attribute">_item</span>: item
            }</pre></div></div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <p>Check that the response is valid.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> ( data[CONTEXT]? <span class="hljs-keyword">and</span> data[GRAPH]? )
            $rootScope.$broadcast <span class="hljs-string">'error'</span>, <span class="hljs-string">'The analysis response is invalid. Please try again later.'</span>
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span></pre></div></div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <p>data is split in a context and a graph.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          context = data[CONTEXT]
          graph = data[GRAPH]

          <span class="hljs-keyword">for</span> item <span class="hljs-keyword">in</span> graph
            id = item[<span class="hljs-string">'@id'</span>]</pre></div></div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              <pre><code>   <span class="hljs-built_in">console</span>.log <span class="hljs-string">"[ id :: <span class="hljs-subst">#{id}</span> ]"</span>
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>
            types = item[<span class="hljs-string">'@type'</span>]
            dctype = h.get <span class="hljs-string">"<span class="hljs-subst">#{DCTERMS}</span>type"</span>, item, context</pre></div></div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              <pre><code>       <span class="hljs-built_in">console</span>.log <span class="hljs-string">"[ id :: <span class="hljs-subst">#{id}</span> ][ dc:type :: <span class="hljs-subst">#{dctype}</span> ]"</span>
</code></pre>
            </div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-41">&#182;</a>
              </div>
              <p>TextAnnotation/LinguisticSystem
           console.log “[ FISE_ONT_TEXT_ANNOTATION :: #{FISE_ONT_TEXT_ANNOTATION} ][ DCTERMS :: #{DCTERMS} ]”</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">if</span> h.containsOrEquals(FISE_ONT_TEXT_ANNOTATION, types, context) <span class="hljs-keyword">and</span> h.containsOrEquals(<span class="hljs-string">"<span class="hljs-subst">#{DCTERMS}</span>LinguisticSystem"</span>, dctype, context)</pre></div></div>
            
        </li>
        
        
        <li id="section-42">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-42">&#182;</a>
              </div>
              <p>dump “language [ id :: #{id} ][ dc:type :: #{dctype} ]”</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>              languages.push createLanguage(item)</pre></div></div>
            
        </li>
        
        
        <li id="section-43">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-43">&#182;</a>
              </div>
              <p>TextAnnotation</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> h.containsOrEquals(FISE_ONT_TEXT_ANNOTATION, types, context)</pre></div></div>
            
        </li>
        
        
        <li id="section-44">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-44">&#182;</a>
              </div>
              <pre><code>     $log.debug <span class="hljs-string">"TextAnnotation [ @id :: <span class="hljs-subst">#{id}</span> ][ types :: <span class="hljs-subst">#{types}</span> ]"</span>
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>              textAnnotations[id] = item</pre></div></div>
            
        </li>
        
        
        <li id="section-45">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-45">&#182;</a>
              </div>
              <p>EntityAnnotation</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> h.containsOrEquals(FISE_ONT_ENTITY_ANNOTATION, types, context)</pre></div></div>
            
        </li>
        
        
        <li id="section-46">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-46">&#182;</a>
              </div>
              <pre><code>     $log.debug <span class="hljs-string">"EntityAnnotation [ @id :: <span class="hljs-subst">#{id}</span> ][ types :: <span class="hljs-subst">#{types}</span> ]"</span>
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>              entityAnnotations[id] = item</pre></div></div>
            
        </li>
        
        
        <li id="section-47">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-47">&#182;</a>
              </div>
              <p>Entity</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">else</span></pre></div></div>
            
        </li>
        
        
        <li id="section-48">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-48">&#182;</a>
              </div>
              <pre><code>     $log.debug <span class="hljs-string">"Entity [ @id :: <span class="hljs-subst">#{id}</span> ][ types :: <span class="hljs-subst">#{types}</span> ]"</span>
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>              entities[id] = item</pre></div></div>
            
        </li>
        
        
        <li id="section-49">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-49">&#182;</a>
              </div>
              <p>sort the languages by confidence.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          languages.sort <span class="hljs-function"><span class="hljs-params">(a, b)</span> -&gt;</span>
            <span class="hljs-keyword">if</span> a.confidence &lt; b.confidence
              <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>
            <span class="hljs-keyword">if</span> a.confidence &gt; b.confidence
              <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>
            <span class="hljs-number">0</span></pre></div></div>
            
        </li>
        
        
        <li id="section-50">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-50">&#182;</a>
              </div>
              <p>create a reference to the default language.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          language = languages[<span class="hljs-number">0</span>].code</pre></div></div>
            
        </li>
        
        
        <li id="section-51">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-51">&#182;</a>
              </div>
              <p>Create entities instances in the entities array.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          entities[id] = EntityService.create(item, language, service._knownTypes, context) <span class="hljs-keyword">for</span> id, item <span class="hljs-keyword">of</span> entities</pre></div></div>
            
        </li>
        
        
        <li id="section-52">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-52">&#182;</a>
              </div>
              <p>Cycle in every entity.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          logger.debug <span class="hljs-string">"AnalysisService : merge"</span>, { <span class="hljs-attribute">entity</span>: entity, <span class="hljs-attribute">entities</span>: entities }
          EntityService.merge(entity, entities) <span class="hljs-keyword">for</span> id, entity <span class="hljs-keyword">of</span> entities <span class="hljs-keyword">if</span> merge
          EntityService.merge(entity, entities) <span class="hljs-keyword">for</span> id, entity <span class="hljs-keyword">of</span> <span class="hljs-property">@_entities</span> <span class="hljs-keyword">if</span> merge</pre></div></div>
            
        </li>
        
        
        <li id="section-53">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-53">&#182;</a>
              </div>
              <p>Create text annotation instances.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          textAnnotations[id] = TextAnnotationService.build(item, context) <span class="hljs-keyword">for</span> id, item <span class="hljs-keyword">of</span> textAnnotations</pre></div></div>
            
        </li>
        
        
        <li id="section-54">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-54">&#182;</a>
              </div>
              <p>Create entity annotations instances.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="hljs-keyword">for</span> id, item <span class="hljs-keyword">of</span> entityAnnotations
            entityAnnotations[entityAnnotation.id] = entityAnnotation <span class="hljs-keyword">for</span> entityAnnotation <span class="hljs-keyword">in</span> EntityAnnotationService.build(item, language, entities, textAnnotations, context)</pre></div></div>
            
        </li>
        
        
        <li id="section-55">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-55">&#182;</a>
              </div>
              <p>For every text annotation delete entity annotations that refer to the same entity (after merging).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="hljs-keyword">if</span> merge</pre></div></div>
            
        </li>
        
        
        <li id="section-56">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-56">&#182;</a>
              </div>
              <p>Cycle in text annotations.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">for</span> textAnnotationId, textAnnotation <span class="hljs-keyword">of</span> textAnnotations</pre></div></div>
            
        </li>
        
        
        <li id="section-57">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-57">&#182;</a>
              </div>
              <p>Cycle in entity annotations.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>              <span class="hljs-keyword">for</span> id, entityAnnotation <span class="hljs-keyword">of</span> textAnnotation.entityAnnotations</pre></div></div>
            
        </li>
        
        
        <li id="section-58">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-58">&#182;</a>
              </div>
              <pre><code>       <span class="hljs-built_in">console</span>.log <span class="hljs-string">"[ text-annotation id :: <span class="hljs-subst">#{textAnnotationId}</span> ][ entity-annotation id :: <span class="hljs-subst">#{entityAnnotation.id}</span> ]"</span>
</code></pre><p>Check if there are entity annotations referring to the same entity, and if so, delete it.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-keyword">for</span> anotherId, anotherEntityAnnotation <span class="hljs-keyword">of</span> textAnnotation.entityAnnotations <span class="hljs-keyword">when</span> id <span class="hljs-keyword">isnt</span> anotherId <span class="hljs-keyword">and</span> entityAnnotation.entity <span class="hljs-keyword">is</span> anotherEntityAnnotation.entity</pre></div></div>
            
        </li>
        
        
        <li id="section-59">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-59">&#182;</a>
              </div>
              <pre><code>         <span class="hljs-built_in">console</span>.log <span class="hljs-string">"[ id :: <span class="hljs-subst">#{id}</span> ][ another id :: <span class="hljs-subst">#{anotherId}</span> ]"</span>
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>                  <span class="hljs-keyword">delete</span> textAnnotation.entityAnnotations[anotherId]</pre></div></div>
            
        </li>
        
        
        <li id="section-60">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-60">&#182;</a>
              </div>
              <p>return the analysis result.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          {
          <span class="hljs-attribute">language</span>: language
          <span class="hljs-attribute">entities</span>: entities
          <span class="hljs-attribute">entityAnnotations</span>: entityAnnotations
          <span class="hljs-attribute">textAnnotations</span>: textAnnotations
          <span class="hljs-attribute">languages</span>: languages
          }</pre></div></div>
            
        </li>
        
        
        <li id="section-61">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-61">&#182;</a>
              </div>
              <p>Return the service instance</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        service
    ])</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>

<!DOCTYPE html>

<html>
<head>
  <title>chord.coffee</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="app.html">
                app.coffee
              </a>
            
              
              <a class="source" href="app.config.html">
                app.config.coffee
              </a>
            
              
              <a class="source" href="app.constants.html">
                app.constants.coffee
              </a>
            
              
              <a class="source" href="app.controllers.html">
                app.controllers.coffee
              </a>
            
              
              <a class="source" href="app.directives.html">
                app.directives.coffee
              </a>
            
              
              <a class="source" href="app.directives.wlEntityProps.html">
                app.directives.wlEntityProps.coffee
              </a>
            
              
              <a class="source" href="app.services.AnalysisService.html">
                app.services.AnalysisService.coffee
              </a>
            
              
              <a class="source" href="app.services.EditorService.html">
                app.services.EditorService.coffee
              </a>
            
              
              <a class="source" href="app.services.EntityAnnotationService.html">
                app.services.EntityAnnotationService.coffee
              </a>
            
              
              <a class="source" href="app.services.EntityService.html">
                app.services.EntityService.coffee
              </a>
            
              
              <a class="source" href="app.services.Helpers.html">
                app.services.Helpers.coffee
              </a>
            
              
              <a class="source" href="app.services.LoggerService.html">
                app.services.LoggerService.coffee
              </a>
            
              
              <a class="source" href="app.services.TextAnnotationService.html">
                app.services.TextAnnotationService.coffee
              </a>
            
              
              <a class="source" href="app.services.html">
                app.services.coffee
              </a>
            
              
              <a class="source" href="traslator.html">
                traslator.coffee
              </a>
            
              
              <a class="source" href="chord.html">
                chord.coffee
              </a>
            
              
              <a class="source" href="EntitiesController.spec.html">
                EntitiesController.spec.coffee
              </a>
            
              
              <a class="source" href="addtl_properties.spec.html">
                addtl_properties.spec.coffee
              </a>
            
              
              <a class="source" href="controllers.error.spec.html">
                controllers.error.spec.coffee
              </a>
            
              
              <a class="source" href="directives.spec.html">
                directives.spec.coffee
              </a>
            
              
              <a class="source" href="services.spec.html">
                services.spec.coffee
              </a>
            
              
              <a class="source" href="tinymce.questa_volta_parliamo_di_seo.spec.html">
                tinymce.questa_volta_parliamo_di_seo.spec.coffee
              </a>
            
              
              <a class="source" href="tinymce.spec.html">
                tinymce.spec.coffee
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>chord.coffee</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>$ = jQuery

<span class="hljs-function"><span class="hljs-title">getChordData</span> = <span class="hljs-params">(params)</span> -&gt;</span>
  $.post params.ajax_url, {
      <span class="hljs-attribute">action</span>:  params.action
      <span class="hljs-attribute">post_id</span>: params.post_id
      <span class="hljs-attribute">depth</span>:   params.depth
  	}, <span class="hljs-function"><span class="hljs-params">(response)</span> -&gt;</span>
    data  = JSON.parse response
    buildChord data, params

<span class="hljs-function"><span class="hljs-title">buildChord</span> = <span class="hljs-params">(data, params)</span> -&gt;</span>
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">if</span> data.entities.length &lt; <span class="hljs-number">2</span></pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p> niceData = ‘entities’ in dataMock &amp;&amp; ‘relations’ in dataMock
 niceData = niceData &amp;&amp; (dataMock.entities.length) &gt;= 2 &amp;&amp; (dataMock.relations &gt;= 1)
 if ( niceData )
   d3.select( ‘#’ + wl_chord_params.widget_id )
    .style(‘height’, ‘50px’)
    .html(‘ —- WordLift shortcode: No entities found. —- ‘)
 return;
}</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
  <span class="hljs-function"><span class="hljs-title">translate</span> = <span class="hljs-params">(x, y, size)</span> -&gt;</span> <span class="hljs-string">'translate('</span> + x * size + <span class="hljs-string">','</span> + y * size + <span class="hljs-string">')'</span>

  <span class="hljs-function"><span class="hljs-title">rotate</span> = <span class="hljs-params">(x)</span> -&gt;</span> <span class="hljs-string">"rotate(<span class="hljs-subst">#{x}</span>)"</span>

  <span class="hljs-function"><span class="hljs-title">rad2deg</span> = <span class="hljs-params">(a)</span> -&gt;</span>  ( a / (<span class="hljs-number">2</span>*Math.PI)) * <span class="hljs-number">360</span>

  <span class="hljs-function"><span class="hljs-title">sign</span> = <span class="hljs-params">(n)</span> -&gt;</span> <span class="hljs-keyword">if</span> n &gt;= <span class="hljs-number">0.0</span> <span class="hljs-keyword">then</span> <span class="hljs-number">1</span> <span class="hljs-keyword">else</span> -<span class="hljs-number">1</span>

  <span class="hljs-function"><span class="hljs-title">beautifyLabel</span> = <span class="hljs-params">(txt)</span> -&gt;</span>
    <span class="hljs-keyword">return</span> txt.substring(<span class="hljs-number">0</span>, <span class="hljs-number">12</span>) + <span class="hljs-string">'...'</span> <span class="hljs-keyword">if</span> txt.length &gt; <span class="hljs-number">12</span>
    txt</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>TODO: why?</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-title">debug</span> = <span class="hljs-params">(d)</span> -&gt;</span> <span class="hljs-built_in">console</span>.log(d)

  <span class="hljs-function"><span class="hljs-title">colorLuminance</span> = <span class="hljs-params">(hex, lum)</span> -&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>Validate hex string.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    hex = String(hex).replace(<span class="hljs-regexp">/[^0-9a-f]/gi</span>, <span class="hljs-string">''</span>)

    <span class="hljs-keyword">if</span> (hex.length &lt; <span class="hljs-number">6</span>)
      hex = hex[<span class="hljs-number">0</span>]+hex[<span class="hljs-number">0</span>]+hex[<span class="hljs-number">1</span>]+hex[<span class="hljs-number">1</span>]+hex[<span class="hljs-number">2</span>]+hex[<span class="hljs-number">2</span>]

    lum = lum <span class="hljs-keyword">or</span> <span class="hljs-number">0</span></pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>Convert to decimal and change luminosity.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    rgb = <span class="hljs-string">"#"</span>
    c = <span class="hljs-literal">undefined</span>
    i = <span class="hljs-literal">undefined</span>

    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> [<span class="hljs-number">0.</span><span class="hljs-number">.3</span>]
      c = parseInt(hex.substr(i*<span class="hljs-number">2</span>,<span class="hljs-number">2</span>), <span class="hljs-number">16</span>)
      c = Math.round(Math.min(Math.max(<span class="hljs-number">0</span>, c + (c * lum)), <span class="hljs-number">255</span>)).toString(<span class="hljs-number">16</span>)
      rgb += (<span class="hljs-string">"00"</span>+c).substr(c.length)

    rgb

  <span class="hljs-function"><span class="hljs-title">getEntityIndex</span> = <span class="hljs-params">(uri)</span> -&gt;</span>
    <span class="hljs-keyword">return</span> i <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> [<span class="hljs-number">0.</span>.data.entities.length] <span class="hljs-keyword">when</span> data.entities[i].uri <span class="hljs-keyword">is</span> uri
    -<span class="hljs-number">1</span></pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>Build adiacency matrix.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  matrix = []
  matrix.push (<span class="hljs-number">0</span> <span class="hljs-keyword">for</span> e <span class="hljs-keyword">in</span> data.entities) <span class="hljs-keyword">for</span> entity <span class="hljs-keyword">in</span> data.entities</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p> console.log “matrix”
 console.log matrix</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
  <span class="hljs-keyword">for</span> relation <span class="hljs-keyword">in</span> data.relations
    x = getEntityIndex relation.s
    y = getEntityIndex relation.o
    matrix[x][y] = <span class="hljs-number">1</span>
    matrix[y][x] = <span class="hljs-number">1</span>

  viz = d3.select(<span class="hljs-string">'#'</span> + params.widget_id ).append(<span class="hljs-string">'svg'</span>)
  viz.attr(<span class="hljs-string">'width'</span>, <span class="hljs-string">'100%'</span>).attr(<span class="hljs-string">'height'</span>, <span class="hljs-string">'100%'</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>Getting dimensions in pixels.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  width = parseInt(viz.style(<span class="hljs-string">'width'</span>))
  height = parseInt(viz.style(<span class="hljs-string">'height'</span>))
  size =  <span class="hljs-keyword">if</span> height &lt; width <span class="hljs-keyword">then</span> height <span class="hljs-keyword">else</span> width
  innerRadius = size*<span class="hljs-number">0.2</span>
  outerRadius = size*<span class="hljs-number">0.25</span>
  arc = d3.svg.arc().innerRadius(innerRadius).outerRadius(outerRadius)

  chord = d3.layout.chord()
    .padding(<span class="hljs-number">0.3</span>)
    .matrix(matrix)</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>Draw relations.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  viz.selectAll(<span class="hljs-string">'chords'</span>)
    .data(chord.chords)
    .enter()
    .append(<span class="hljs-string">'path'</span>)
    .attr(<span class="hljs-string">'class'</span>, <span class="hljs-string">'relation'</span>)
    .attr(<span class="hljs-string">'d'</span>, d3.svg.chord().radius(innerRadius))
    .attr(<span class="hljs-string">'transform'</span>, translate(<span class="hljs-number">0.5</span>, <span class="hljs-number">0.5</span>, size) )
    .style(<span class="hljs-string">'opacity'</span>, <span class="hljs-number">0.2</span>)
    .<span class="hljs-literal">on</span>(<span class="hljs-string">'mouseover'</span>,<span class="hljs-function"> -&gt;</span>  d3.select(<span class="hljs-keyword">this</span>).style(<span class="hljs-string">'opacity'</span>, <span class="hljs-number">0.8</span>) )
    .<span class="hljs-literal">on</span>(<span class="hljs-string">'mouseout'</span>,<span class="hljs-function"> -&gt;</span>  d3.select(<span class="hljs-keyword">this</span>).style(<span class="hljs-string">'opacity'</span>, <span class="hljs-number">0.2</span>) )</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>Draw entities.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  viz.selectAll(<span class="hljs-string">'arcs'</span>)
    .data(chord.groups)
    .enter()
    .append(<span class="hljs-string">'path'</span>)
    .attr<span class="hljs-function"><span class="hljs-params">(<span class="hljs-string">'class'</span>, (d) -&gt;
      <span class="hljs-keyword">return</span> <span class="hljs-string">"entity <span class="hljs-subst">#{data.entities[d.index].css_class}</span>"</span>
    )</span>
    .<span class="hljs-title">attr</span><span class="hljs-params">(<span class="hljs-string">'d'</span>, arc)</span>
    .<span class="hljs-title">attr</span><span class="hljs-params">(<span class="hljs-string">'transform'</span>, translate(<span class="hljs-number">0.5</span>, <span class="hljs-number">0.5</span>, size))</span>
    .<span class="hljs-title">style</span><span class="hljs-params">(<span class="hljs-string">'fill'</span>, (d) -&gt;
      baseColor = params.main_color;
      type = data.entities[d.index].type
      <span class="hljs-keyword">return</span> baseColor <span class="hljs-keyword">if</span>(type == <span class="hljs-string">'post'</span>)
      <span class="hljs-keyword">return</span> colorLuminance( baseColor, -<span class="hljs-number">0.5</span>) <span class="hljs-keyword">if</span> type <span class="hljs-keyword">is</span> <span class="hljs-string">'entity'</span>
      colorLuminance( baseColor, <span class="hljs-number">0.5</span> )
    )</span>

</span></pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>Draw entity labels.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  viz.selectAll(<span class="hljs-string">'arcs_labels'</span>)
    .data(chord.groups)
    .enter()
    .append(<span class="hljs-string">'text'</span>)
    .attr(<span class="hljs-string">'class'</span>, <span class="hljs-string">'label'</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>   .html( (d) -&gt;
     lab = data.entities[d.index].label
     beautifyLabel(lab)
   )</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    .attr(<span class="hljs-string">'font-size'</span>,<span class="hljs-function"> -&gt;</span>
      fontSize = parseInt( size/<span class="hljs-number">35</span> )
      fontSize = <span class="hljs-number">8</span> <span class="hljs-keyword">if</span>(fontSize &lt; <span class="hljs-number">8</span>)
      fontSize + <span class="hljs-string">'px'</span>
    )
    .each<span class="hljs-function"><span class="hljs-params">( (d) -&gt;
      n = data.entities[d.index].label.split(<span class="hljs-regexp">/\s/</span>)

</span></span></pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>get the current element</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      text = d3.select(<span class="hljs-keyword">this</span>)
        .attr(<span class="hljs-string">"dy"</span>, n.length / <span class="hljs-number">3</span> - (n.length-<span class="hljs-number">1</span>) * <span class="hljs-number">0.9</span> + <span class="hljs-string">'em'</span>)
        .html(n[<span class="hljs-number">0</span>])</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>now loop</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> [<span class="hljs-number">1.</span>.n.length]
        text.append(<span class="hljs-string">"tspan"</span>)
        .attr(<span class="hljs-string">'x'</span>, <span class="hljs-number">0</span>)
        .attr(<span class="hljs-string">'dy'</span>, <span class="hljs-string">'1em'</span>)
        .html(n[i])

      text.attr<span class="hljs-function"><span class="hljs-params">(<span class="hljs-string">'transform'</span>, (d) -&gt;
        alpha = d.startAngle - Math.PI/<span class="hljs-number">2</span> + Math.abs((d.endAngle - d.startAngle)/<span class="hljs-number">2</span>)
        labelWidth = <span class="hljs-number">3</span>
        labelAngle = <span class="hljs-literal">undefined</span>
        <span class="hljs-keyword">if</span>(alpha &gt; Math.PI/<span class="hljs-number">2</span>)
          labelAngle = alpha - Math.PI
          labelWidth += d3.select(<span class="hljs-keyword">this</span>)[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>].clientWidth
        <span class="hljs-keyword">else</span>
          labelAngle = alpha

        labelAngle = rad2deg( labelAngle )

        r = (outerRadius + labelWidth)/size
        x = <span class="hljs-number">0.5</span> + ( r * Math.cos(alpha) )
        y = <span class="hljs-number">0.5</span> + ( r * Math.sin(alpha) )

        translate(x, y, size) + rotate( labelAngle )
      )</span>

  )

</span></pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>Creating an hidden tooltip.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  tooltip = d3.select(<span class="hljs-string">'body'</span>).append(<span class="hljs-string">'div'</span>)
    .attr(<span class="hljs-string">'class'</span>, <span class="hljs-string">'tooltip'</span>)
    .style(<span class="hljs-string">'background-color'</span>, <span class="hljs-string">'white'</span>)
    .style(<span class="hljs-string">'opacity'</span>, <span class="hljs-number">0.0</span>)
    .style(<span class="hljs-string">'position'</span>, <span class="hljs-string">'absolute'</span>)
    .style(<span class="hljs-string">'z-index'</span>, <span class="hljs-number">100</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p> Dynamic behavior for entities.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  viz.selectAll(<span class="hljs-string">'.entity, .label'</span>)
    .<span class="hljs-literal">on</span><span class="hljs-function"><span class="hljs-params">(<span class="hljs-string">'mouseover'</span>, (c) -&gt;
      d3.select(<span class="hljs-keyword">this</span>).attr(<span class="hljs-string">'cursor'</span>,<span class="hljs-string">'pointer'</span>)
      viz.selectAll(<span class="hljs-string">'.relation'</span>)
        .filter( (d, i) -&gt; d.source.index <span class="hljs-keyword">is</span> c.index <span class="hljs-keyword">or</span> d.target.index <span class="hljs-keyword">is</span> c.index )
        .style( <span class="hljs-string">'opacity'</span>, <span class="hljs-number">0.8</span>)

</span></span></pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>Show tooltip.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      tooltip.text( data.entities[c.index].label ).style(<span class="hljs-string">'opacity'</span>, <span class="hljs-number">1.0</span> )
    )
    .<span class="hljs-literal">on</span><span class="hljs-function"><span class="hljs-params">(<span class="hljs-string">'mouseout'</span>, (c) -&gt;
      viz.selectAll(<span class="hljs-string">'.relation'</span>)
        .filter( (d, i) -&gt; d.source.index <span class="hljs-keyword">is</span> c.index <span class="hljs-keyword">or</span> d.target.index <span class="hljs-keyword">is</span> c.index )
        .style( <span class="hljs-string">'opacity'</span>, <span class="hljs-number">0.2</span> )

</span></span></pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>Hide tooltip.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        tooltip.style(<span class="hljs-string">'opacity'</span>, <span class="hljs-number">0.0</span>)
    )
    .<span class="hljs-literal">on</span>(<span class="hljs-string">'mousemove'</span>,<span class="hljs-function"> -&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>Change tooltip position.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      tooltip.style(<span class="hljs-string">"left"</span>, (d3.event.pageX) + <span class="hljs-string">"px"</span>)
        .style(<span class="hljs-string">"top"</span>, (d3.event.pageY - <span class="hljs-number">30</span>) + <span class="hljs-string">"px"</span>)
    )
    .<span class="hljs-literal">on</span><span class="hljs-function"><span class="hljs-params">(<span class="hljs-string">'click'</span>, (d) -&gt;
      url = data.entities[d.index].url
      <span class="hljs-built_in">window</span>.location = url
    )</span>


<span class="hljs-title">getChordData</span> <span class="hljs-title">wl_chord_params</span>
</span></pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
